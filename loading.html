<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loading...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { --ink:#fff; --black:#000; }
    * { box-sizing: border-box; }
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family: Arial, Helvetica, sans-serif;
      min-height:100vh;
    }

    /* TOP BANNER (LOGO ONLY) */
    .top-banner{
      width:100%;
      background:#000;
      aspect-ratio: 8 / 1;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:56px;
      position:relative;
    }
    .top-banner img{
      height:82%;
      width:auto;
      max-width:90vw;
      object-fit:contain;
      display:block;
    }

    /* LOADING */
    .stage{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 3rem 1rem;
    }
    .wrap{
      text-align:center;
      padding:2rem;
      max-width:760px;
      width:100%;
    }
    .spinner{
      width:56px; height:56px;
      border:6px solid #333;
      border-top-color:#fff;
      border-radius:50%;
      margin:0 auto 1rem;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .txt{ opacity:0.92; font-size:1rem; }
    .sub{ opacity:0.65; margin-top:0.35rem; font-size:0.9rem; line-height:1.35; }
    .badge{
      display:inline-block;
      margin-top:0.9rem;
      padding:0.25rem 0.6rem;
      border:1px solid #333;
      border-radius:999px;
      font-size:0.8rem;
      opacity:0.7;
    }
    .err{
      display:none;
      margin-top:1.1rem;
      background:#111;
      border:1px solid #333;
      padding:1rem;
      border-radius:12px;
      color:#fff;
      text-align:left;
      font-size:0.92rem;
      opacity:0.95;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="top-banner">
    <a href="index.html" style="display:flex; align-items:center; justify-content:center; height:100%; width:100%;">
      <img src="White Logo.jpg" alt="League Logo">
    </a>
  </div>

  <div class="stage">
    <div class="wrap">
      <div class="spinner"></div>
      <div class="txt" id="mainTxt">Preparing your secure Stripe checkout…</div>
      <div class="sub" id="subTxt">One moment. You’ll be redirected automatically.</div>
      <div class="badge" id="badge">LOADING VERSION: SPLIT-SUCCESS-003 + TEAMTOKEN</div>
      <div class="err" id="errBox"></div>
    </div>
  </div>

  <script>
    (async function () {
      const BACKEND_URL = "https://hff-server.onrender.com";

      const errBox = document.getElementById('errBox');
      const mainTxt = document.getElementById('mainTxt');
      const subTxt = document.getElementById('subTxt');

      function showError(msg) {
        errBox.style.display = 'block';
        errBox.textContent = msg;
      }

      function getRawPayload() {
        return (
          sessionStorage.getItem('HFF_CHECKOUT_PAYLOAD') ||
          localStorage.getItem('HFF_CHECKOUT_PAYLOAD')
        );
      }

      function safeJson(raw) {
        try { return JSON.parse(raw); } catch { return null; }
      }

      const raw = getRawPayload();
      const parsed = raw ? safeJson(raw) : null;

      if (!raw || !parsed) {
        window.location.replace('cart.html?v=' + Date.now());
        return;
      }

      // Determine flow type
      const isRegistration =
        parsed.type === 'registration' ||
        (parsed.data && parsed.data.parent && parsed.data.player) ||
        (parsed.parent && parsed.player);

      if (mainTxt) {
        mainTxt.textContent = isRegistration
          ? 'Preparing your registration payment…'
          : 'Preparing your shop checkout…';
      }

      const successPath = isRegistration ? '/success.html' : '/cart_success.html';
      const successUrl = window.location.origin + successPath + '?session_id={CHECKOUT_SESSION_ID}';
      const cancelUrl = window.location.origin + (isRegistration ? '/register.html' : '/cart.html');

      let body;

      if (isRegistration) {
        const reg = parsed.data || parsed;

        // ✅ TEAM TOKEN (optional; used for girls team link registrations)
        const teamToken = (reg && reg.teamToken) ? String(reg.teamToken).trim() : '';

        if (teamToken && subTxt) {
          subTxt.textContent = 'Team link detected. Connecting your registration to the team…';
        }

        // Pricing logic (unchanged)
        const ageGroup = reg.ageGroup; // "U6" or "7plus"
        const fee = (ageGroup === 'U6') ? 80 : 185;

        const playerName =
          (reg.player && (reg.player.firstName || reg.player.lastName))
            ? ((reg.player.firstName || '') + ' ' + (reg.player.lastName || '')).trim()
            : '';

        const cart = [{
          name: (ageGroup === 'U6') ? 'Player Registration (U6)' : 'Player Registration (Age 6+)',
          price: fee,
          quantity: 1
        }];

        body = {
          cart,
          athleteName: playerName || (reg.parent && reg.parent.name) || 'Registration',
          registration: reg,
          teamToken: teamToken || null,  // ✅ NEW: explicit field for backend
          successUrl,
          cancelUrl
        };
      } else {
        body = {
          cart: parsed.cart,
          athleteName: parsed.athleteName || '',
          successUrl,
          cancelUrl
        };
      }

      try {
        const res = await fetch(BACKEND_URL + '/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const text = await res.text();
        if (!res.ok) throw new Error(`POST /create-checkout-session failed (${res.status}).\n${text}`);

        const out = JSON.parse(text);
        const url = out.url || out.checkoutUrl || out.sessionUrl;
        if (!url) throw new Error('No Stripe checkout URL returned.\n\n' + text);

        window.location.href = url;
      } catch (e) {
        showError(
          "Stripe checkout failed.\n\nBackend:\n" + BACKEND_URL + "\n\n" +
          (e && e.message ? e.message : String(e))
        );

        setTimeout(() => {
          const back = isRegistration ? 'register.html' : 'cart.html';
          window.location.replace(back + '?v=' + Date.now());
        }, 6000);
      }
    })();
  </script>
</body>
</html>
